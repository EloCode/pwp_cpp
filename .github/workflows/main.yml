
name: CI

on:
  push:
    branches: [ "develop" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch:

env:
  VCPKG_ROOT: ${{ github.workspace }}/vcpkg
  VCPKG_FEATURE_FLAGS: manifests,binarycaching
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/.vcpkg-cache

jobs:
  build_and_test_linux:
    name: Build & Test (Ubuntu)
    runs-on: ubuntu-latest
    env:
      VCPKG_TRIPLET: x64-linux
      BUILD_TYPE: Debug

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare vcpkg binary cache dir
        run: mkdir -p "$VCPKG_DEFAULT_BINARY_CACHE"

      - name: Cache vcpkg binary cache
        uses: actions/cache@v3
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_TRIPLET }}-${{ hashFiles('src/vcpkg.json', 'src/vcpkg-configuration.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-${{ env.VCPKG_TRIPLET }}-

      - name: Install vcpkg and project dependencies
        run: |
          git clone --depth 1 https://github.com/microsoft/vcpkg.git "$VCPKG_ROOT"
          "$VCPKG_ROOT/bootstrap-vcpkg.sh" -disableMetrics
          "$VCPKG_ROOT/vcpkg" install \
            --triplet "$VCPKG_TRIPLET" \
            --x-manifest-root="$GITHUB_WORKSPACE/src" \
            --clean-after-build

      - name: Configure (CMake)
        run: |
          cmake -S src -B build \
            -D CMAKE_BUILD_TYPE=${BUILD_TYPE} \
            -D CMAKE_TOOLCHAIN_FILE="$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake" \
            -D VCPKG_TARGET_TRIPLET=${VCPKG_TRIPLET}

      - name: Build (CMake)
        run: cmake --build build -j 4

      - name: Test (CTest)
        run: ctest --output-on-failure --test-dir build

  build_and_test_windows:
    name: Build & Test (Windows)
    runs-on: windows-latest
    defaults:
      run:
        shell: pwsh -NoProfile -NonInteractive -Command "$ErrorActionPreference='Stop'; & {0}"
    env:
      VCPKG_TRIPLET: x64-windows
      BUILD_TYPE: Debug

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare vcpkg binary cache dir
        run: |
          if (-not (Test-Path $env:VCPKG_DEFAULT_BINARY_CACHE)) {
            New-Item -ItemType Directory -Path $env:VCPKG_DEFAULT_BINARY_CACHE | Out-Null
          }

      - name: Cache vcpkg binary cache
        uses: actions/cache@v3
        with:
          path: ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}
          key: ${{ runner.os }}-vcpkg-${{ env.VCPKG_TRIPLET }}-${{ hashFiles('src/vcpkg.json', 'src/vcpkg-configuration.json') }}
          restore-keys: |
            ${{ runner.os }}-vcpkg-${{ env.VCPKG_TRIPLET }}-

      - name: Install vcpkg and project dependencies
        run: |
          git clone --depth 1 https://github.com/microsoft/vcpkg.git $env:VCPKG_ROOT
          & "$env:VCPKG_ROOT\bootstrap-vcpkg.bat" -disableMetrics
          & "$env:VCPKG_ROOT\vcpkg.exe" install `
            --triplet "$env:VCPKG_TRIPLET" `
            --x-manifest-root="$env:GITHUB_WORKSPACE\src" `
            --clean-after-build

      - name: Configure (CMake)
        run: >
          cmake -S src -B build
          -D CMAKE_TOOLCHAIN_FILE="$env:VCPKG_ROOT\scripts\buildsystems\vcpkg.cmake"
          -D VCPKG_TARGET_TRIPLET=$env:VCPKG_TRIPLET
          -A x64

      - name: Build (CMake)
        run: cmake --build build --config $env:BUILD_TYPE -- /m

      - name: Test (CTest)
        run: ctest --output-on-failure --test-dir build -C $env:BUILD_TYPE
